From 3e4041b5a59800d7ea608ae5c530b18eee68220b Mon Sep 17 00:00:00 2001
From: Themaister <maister@archlinux.us>
Date: Tue, 15 Mar 2011 21:11:05 +0100
Subject: [PATCH] RSound plugin

---
 Makefile.am                |    6 ++
 configure.ac               |   17 ++++
 src/output/rsound_plugin.c |  182 ++++++++++++++++++++++++++++++++++++++++++++
 src/output_list.c          |    4 +
 4 files changed, 209 insertions(+), 0 deletions(-)
 create mode 100644 src/output/rsound_plugin.c

diff --git a/Makefile.am b/Makefile.am
index 7b41d1c..396178f 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -51,6 +51,7 @@ mpd_headers = \
 	src/output_state.h \
 	src/output_print.h \
 	src/output_command.h \
+	src/output/rsound.h \
 	src/filter_internal.h \
 	src/filter_config.h \
 	src/filter_plugin.h \
@@ -675,6 +676,7 @@ OUTPUT_LIBS = \
 	$(AO_LIBS) \
 	$(ALSA_LIBS) \
 	$(ROAR_LIBS) \
+	$(RSOUND_LIBS) \
 	$(FFADO_LIBS) \
 	$(JACK_LIBS) \
 	$(OPENAL_LIBS) \
@@ -713,6 +715,10 @@ OUTPUT_SRC += src/output/roar_plugin.c
 MIXER_SRC += src/mixer/roar_mixer_plugin.c
 endif
 
+if HAVE_RSOUND
+OUTPUT_SRC += src/output/rsound_plugin.c
+endif
+
 if ENABLE_FFADO_OUTPUT
 OUTPUT_SRC += src/output/ffado_output_plugin.c
 endif
diff --git a/configure.ac b/configure.ac
index 0d07555..14a807f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -131,6 +131,11 @@ AC_ARG_ENABLE(ao,
 		[enable support for libao]),,
 	enable_ao=auto)
 
+AC_ARG_ENABLE(rsound,
+	AS_HELP_STRING([--enable-rsound],
+		[enable support for rsound]),,
+	enable_rsound=auto)
+
 AC_ARG_ENABLE(audiofile,
 	AS_HELP_STRING([--enable-audiofile],
 		[enable audiofile support (WAV and others)]),,
@@ -1236,6 +1241,16 @@ fi
 
 AM_CONDITIONAL(HAVE_ROAR, test x$enable_roar = xyes)
 
+dnl ---------------------------------- RSOUND ---------------------------------
+MPD_AUTO_PKG(rsound, RSOUND, [rsound >= 1.0],
+	[RSOUND output plugin], [librsound not found])
+
+if test x$enable_rsound = xyes; then
+	AC_DEFINE(HAVE_RSOUND, 1, [Define to enable RSOUND support])
+fi
+
+AM_CONDITIONAL(HAVE_RSOUND, test x$enable_rsound = xyes)
+
 dnl ----------------------------------- FFADO ---------------------------------
 
 MPD_AUTO_PKG(ffado, FFADO, [libffado],
@@ -1446,6 +1461,7 @@ dnl --------------------- Post Audio Output Plugins Tests ---------------------
 if
 	test x$enable_alsa = xno &&
 	test x$enable_roar = xno &&
+	test x$enable_rsound = xno &&
 	test x$enable_ao = xno &&
 	test x$enable_ffado = xno &&
 	test x$enable_fifo = xno &&
@@ -1583,6 +1599,7 @@ results(id3,[ID3])
 printf '\nPlayback support:\n\t'
 results(alsa,ALSA)
 results(roar,ROAR)
+results(rsound,RSOUND)
 results(ffado,FFADO)
 results(fifo,FIFO)
 results(recorder_output,[File Recorder])
diff --git a/src/output/rsound_plugin.c b/src/output/rsound_plugin.c
new file mode 100644
index 0000000..c53921f
--- /dev/null
+++ b/src/output/rsound_plugin.c
@@ -0,0 +1,182 @@
+/*
+ * Copyright (C) 2003-2010 The Music Player Daemon Project
+ * Copyright (C) 2010-2011 Hans-Kristian Arntzen
+ * http://www.musicpd.org
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
+
+#include "config.h"
+#include "output_api.h"
+#include "mixer_list.h"
+#include <rsound.h>
+#include <glib.h>
+
+#undef G_LOG_DOMAIN
+#define G_LOG_DOMAIN "rsound"
+
+typedef struct
+{
+	rsound_t *rd;
+	bool canceled;
+} rsd_t;
+
+static inline GQuark
+rsound_output_quark(void)
+{
+	return g_quark_from_static_string("rsound_output");
+}
+
+static void
+rsound_configure(rsound_t *rd, const struct config_param *param)
+{
+	char *host = config_dup_block_string(param, "host", "");
+	char *port = config_dup_block_string(param, "port", "");
+	char *ident = config_dup_block_string(param, "name", "MPD");
+
+	if (host && *host)
+		rsd_set_param(rd, RSD_HOST, host);
+	if (port && *port)
+		rsd_set_param(rd, RSD_PORT, port);
+	if (ident && *ident)
+		rsd_set_param(rd, RSD_IDENTITY, ident);
+
+	g_free(host);
+	g_free(port);
+	g_free(ident);
+}
+
+static void *
+rsound_init(G_GNUC_UNUSED const struct audio_format *audio_format,
+		const struct config_param *param,
+		G_GNUC_UNUSED GError **error)
+{
+	rsd_t *rsd = g_new0(rsd_t, 1);
+
+	rsound_t *rd;
+	if (rsd_init(&rd) < 0)
+	{
+		g_set_error(error, rsound_output_quark(), 0, "Failed to initialize");
+		return NULL;
+	}
+
+	rsd->rd = rd;
+	rsound_configure(rd, param);
+	return rsd;
+}
+
+static void
+rsound_finish(void *data)
+{
+	rsd_t *rsd = data;
+	rsd_free(rsd->rd);
+	g_free(rsd);
+}
+
+static bool
+rsound_open(void *data, struct audio_format *audio_format, GError **error)
+{
+	rsd_t *rsd = data;
+
+	rsd_set_param(rsd->rd, RSD_SAMPLERATE, &audio_format->sample_rate);
+	rsd_set_param(rsd->rd, RSD_CHANNELS, &audio_format->channels);
+
+	int format;
+	switch (audio_format->format)
+	{
+		case SAMPLE_FORMAT_S8:
+			format = RSD_S8;
+			break;
+
+		case SAMPLE_FORMAT_S16:
+			format = RSD_S16_NE;
+			break;
+
+		case SAMPLE_FORMAT_S24_P32:
+			audio_format->format = SAMPLE_FORMAT_S32;
+		case SAMPLE_FORMAT_S32:
+			format = RSD_S32_NE;
+			break;
+
+		default:
+			format = RSD_S16_NE;
+			audio_format->format = SAMPLE_FORMAT_S16;
+	}
+
+	audio_format->reverse_endian = 0;
+	rsd_set_param(rsd->rd, RSD_FORMAT, &format);
+
+	if (rsd_start(rsd->rd) < 0)
+	{
+		g_set_error(error, rsound_output_quark(), 0, 
+				"Failed to connect to server");
+		return false;
+	}
+	return true;
+}
+
+static void
+rsound_cancel(void *data)
+{
+	rsd_t *rsd = data;
+	rsd_stop(rsd->rd);
+	rsd->canceled = true;
+}
+
+static void
+rsound_close(void *data)
+{
+	rsd_t *rsd = data;
+	rsd_stop(rsd->rd);
+}
+
+static size_t
+rsound_play(void *data, const void *chunk, size_t size, GError **error)
+{
+	rsd_t *rsd = data;
+
+	if (rsd->canceled)
+	{
+		if (rsd_start(rsd->rd) < 0)
+		{
+			g_set_error(error, rsound_output_quark(), 0, 
+					"Failed to recover after cancel");
+			return false;
+		}
+		rsd->canceled = false;
+	}
+
+	size_t rc;
+	rc = rsd_write(rsd->rd, chunk, size);
+	if (rc == 0)
+	{
+		g_set_error(error, rsound_output_quark(), 0, "Failed to play data");
+		return 0;
+	}
+
+	return rc;
+}
+
+const struct audio_output_plugin rsound_output_plugin = {
+	.name = "rsound",
+	.init = rsound_init,
+	.finish = rsound_finish,
+	.open = rsound_open,
+	.play = rsound_play,
+	.cancel = rsound_cancel,
+	.close = rsound_close,
+};
+
+
diff --git a/src/output_list.c b/src/output_list.c
index 75d24d6..4594b48 100644
--- a/src/output_list.c
+++ b/src/output_list.c
@@ -38,6 +38,7 @@ extern const struct audio_output_plugin mvp_output_plugin;
 extern const struct audio_output_plugin jack_output_plugin;
 extern const struct audio_output_plugin httpd_output_plugin;
 extern const struct audio_output_plugin recorder_output_plugin;
+extern const struct audio_output_plugin rsound_output_plugin;
 extern const struct audio_output_plugin winmm_output_plugin;
 extern const struct audio_output_plugin ffado_output_plugin;
 
@@ -91,6 +92,9 @@ const struct audio_output_plugin *audio_output_plugins[] = {
 #ifdef ENABLE_RECORDER_OUTPUT
 	&recorder_output_plugin,
 #endif
+#ifdef HAVE_RSOUND
+	&rsound_output_plugin,
+#endif
 #ifdef ENABLE_WINMM_OUTPUT
 	&winmm_output_plugin,
 #endif
-- 
1.7.4.1

